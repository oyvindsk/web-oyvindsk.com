
---
Title: Tinkering with the Docker source code - Callgraph
Author: Me
Description: Whatever
Date: 2015-06-03 17h
Path: docker-callgraph
---

    <article>

        <header>
            <h1>Tinkering with the Docker source code - Disabling docker exec</h1>
            <span>11th March 2015</span>
        </header>


        <p>
            Goals:
            Step 1 - Compile and run Docker (daemon and client) from source
            Step 2 - Modiy the soure to disable "docker exec"
            Step 3 - Re-compile and check that it works
        </p>

        <p>
            https://www.digitalocean.com/?refcode=b099d6f54603
        </p> 


        <h2>Installing Docker</h2>
        <p>
            Follow the instructions at <a href="https://docs.docker.com/installation/">https://docs.docker.com/installation/</a> for the long version. 
        </p>
        <p>
            For ubuntu this is basically:
            <figure class="file"><figcaption></figcaption><code><pre>
# as root (or prepend with sudo)
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 
sh -c "echo deb https://get.docker.com/ubuntu docker main > /etc/apt/sources.list.d/docker.list"
apt-get update
apt-get install lxc-docker

# Get some dependencies
apt-get install make git
            </pre></code></figure>
        </p> 


<h3>On Digital Ocean? Create some swap space</h3>
I've had some issues with docker on the smallest Digital Ocean plan. I think it's because it runs out of ram and does not have any swap space to fall back to. You can fix this, I think, by creating and enabling some swap space:

# as root (or prepend with sudo)
dd if=/dev/zero of=/swapfile bs=1M count=1000
chmod 600 /swapfile 
mkswap /swapfile 
swapon /swapfile 
swapon -s

Read more <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">in this Digital Ocean tuturial</a> and <a href="http://askubuntu.com/questions/566745/allocate-swap-after-ubuntu-14-04-lts-installation">this AskUbuntu question</a>

Test that it worked:
free -h


<h3>Compile docker in a docker container</h3>
The Dockerfile makes it pretty easy to compile a new docker from source, it does all the heavy lifting for you. This works by first building a new docker image from the Dockerfile
https://github.com/docker/docker/blob/master/Dockerfile

to make binar a docker daemon (docker -d) must be running. Either a new one or the old one installed on the host


git clone https://github.com/docker/docker.git
cd docker
# as root (or prepend with sudo)
make build # this takes a while
make binary


Read more at <a href="http://docs.docker.com/contributing/devenvironment/#check-out-the-source">docs.docker.com</a>


<h3>Test the new binary</h3>

# stop the docker daemon
service docker stop # On Ubuntu. On other systems it might be.. something else

# start a daemon with the new binary
# in the docker/ directory where we ran make build and make binary
./bundles/1.7.0-dev/binary/docker -d  # the version, "1.7.0-dev", will vary according to the version your building


Open a new console / terminal and run:
docker version

This will use the original docker as a client and it should be able to contact our new docker binary. You should see the difference in server version and client version, like so:

docker version

Client version: 1.6.0
Client API version: 1.18
Go version (client): go1.4.2
Git commit (client): 4749651
OS/Arch (client): linux/amd64
Server version: 1.7.0-dev
Server API version: 1.19
Go version (server): go1.4.2
Git commit (server): 1b4de6f
OS/Arch (server): linux/amd64


You can test the new binary as a client as well:

./docker/bundles/1.7.0-dev/binary/docker version # (new terminal, current working directory is /root)

Client version: 1.7.0-dev
Client API version: 1.19
Go version (client): go1.4.2
Git commit (client): 1b4de6f
OS/Arch (client): linux/amd64
Server version: 1.7.0-dev
Server API version: 1.19
Go version (server): go1.4.2
Git commit (server): 1b4de6f
OS/Arch (server): linux/amd64


TEST docker exec
# Run a container

./docker/bundles/1.7.0-dev/binary/docker run --name test -t -i -d ubuntu bash
./docker/bundles/1.7.0-dev/binary/docker exec test hostname   # result will be something random

# You can stop the test conatiner with:
./docker/bundles/1.7.0-dev/binary/docker stop $(./docker/bundles/1.7.0-dev/binary/docker ps -l -q)  # (last conatiner, only print id)



<h1>Step 2</h2>

EXPLORING THE SOURCE CODE:
apt-get install golang
root@lisa:~/docker# mkdir ~/gocode && export GOPATH=~/gocode

root@lisa:~/docker# docker run -v `pwd`:/go/src/github.com/docker/docker --privileged -i -t docker:master  bash

go get golang.org/x/tools/cmd/callgraph
go get golang.org/x/tools/cmd/digraph

go get github.com/kisielk/godepgraph
apt-get install graphviz
godepgraph ./docker/ | dot -Tsvg
root@1ae967bf34e2:/go/src/github.com/docker/docker# godepgraph -s --horizontal ./docker/ | dot -Tsvg > test3.svg 

<img src="/blogpost-files/docker/Canvas%201.svg">

https://github.com/docker/docker
seems about right, it has a docker/ folder 

MODIFY THE CLIENT

git checkout -b no-exec

Remove the help text:

edit:
    ./docker/flags.go
        86 - description

This does not acutally affect the functionality, just the text printed out whn running 'docker --help' 


Looking arround for the code that actually implements exec. Since we're modifying the client, docker/client.go looks promising, but.. no, it's almost empty and has "+build !daemon" which probably means it's not build when building the daemon.

looking at imports, it looks like it's the ile docker/api/

    edit:
    ./api/client/commands.go
        2525 - 
	// Disable the exec command in this client
	fmt.Fprint(cli.out, " exec is disabled\n")
	return &utils.StatusError{StatusCode: 1}


root@lisa:~/docker# ./bundles/1.5.0-dev/binary/docker rm test ; ./bundles/1.5.0-dev/binary/docker run  --name test -t -i -d ubuntu bash

root@lisa:~/docker# ./bundles/1.5.0-dev/binary/docker exec test hostname
 exec is disabled


MODIFY THE DAEMON

docker -d -D 
debug otput:

    DEBU[0068] Calling POST /containers/{name:.*}/exec      
    INFO[0068] POST /v1.18/containers/test/exec             
    INFO[0068] +job execCreate(test)                        
    INFO[0068] +job log(exec_create: hostname , 5f68ba19b5227c236c4618532595be316d4936f463085dad08b234571a3bbba3, ubuntu:14.04) 
    INFO[0068] -job log(exec_create: hostname , 5f68ba19b5227c236c4618532595be316d4936f463085dad08b234571a3bbba3, ubuntu:14.04) = OK (0) 
    INFO[0068] -job execCreate(test) = OK (0)               
    DEBU[0068] Calling POST /exec/{name:.*}/start           
    INFO[0068] POST /v1.18/exec/40519852c26c6d3903b93f44448e6ee005f60b0bc56bb3d1cac49db32a187f0f/start 
    INFO[0068] +job execStart(40519852c26c6d3903b93f44448e6ee005f60b0bc56bb3d1cac49db32a187f0f) 
    DEBU[0068] starting exec command 40519852c26c6d3903b93f44448e6ee005f60b0bc56bb3d1cac49db32a187f0f in container 5f68ba19b5227c236c4618532595be316d4936f463085dad08b234571a3bbba3 










root@lisa:~/docker# pkill docker
root@lisa:~/docker# ./bundles/1.5.0-dev/binary/docker -d > /dev/null 2>&1 &

root@lisa:~/docker# docker rm test
test
root@lisa:~/docker# ./bundles/1.5.0-dev/binary/docker run  --name test -t -i -d ubuntu bash
f6529f9bdba1e6b335a5332af4ac3a5906bf302ff2c3c995c4b5f95b0e04f77f
root@lisa:~/docker# ./bundles/1.5.0-dev/binary/docker exec test hostname
f6529f9bdba1

root@www:~# du -hs docker/
58M     docker/


Release:        14.10

https://docs.docker.com/installation/#installation


cd docker
make build
make binary


    </article>
